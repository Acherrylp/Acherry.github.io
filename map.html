<!DOCTYPE html>
<html lang="th">
	<head>
		<title>ระบบแสดงแผนที่ </title>
		<meta charset="utf-8">
		<script src="../js/jquery-1.11.1.min.js"></script>
		<script src="../js/bootstrap.min.js"></script>
		<script src="../js/moment-with-locales.min.js"></script>
		<script src="../js/lodash.compat.min.js"></script>
		<!-- 	<script src="js/daterangepicker.js"></script> -->

		<script src="../js/angular.min.js"></script>
		<script src="../js/angular-route.min.js"></script>
		<script src="../js/angular-sanitize.min.js"></script>
<!-- 		<script src="js/datetimepicker.js"></script> -->
<!-- 		<script src="js/angular-daterangepicker.min.js"></script> -->
		<!-- 	<script src="js/ng-bs-daterangepicker.min.js"></script> -->
<!-- 		<script src="js/ui-bootstrap-tpls-0.11.2.min.js"></script> -->
		<script src="../js/ui-bootstrap-tpls-0.12.0.min.js"></script>
		<script src="../js/select.min.js"></script>
		<script src="../js/dirPagination.js"></script>
<!-- 		<script src="js/ui-grid-unstable.min.js"></script> -->
		<script src="../js/i18n/angular-locale_th-th.js"></script>

		<script src="../js/angular-google-maps.min.js"></script>
		<script src="../js/raphael-min.js"></script>
		<script src="../js/morris.min.js"></script>
		<script src="../js/ng-csv.min.js"></script>

		<!--<script src="http://maps.google.com/maps/api/js?sensor=false&language=th" type="text/javascript"></script>-->
		<script src="http://maps.google.com/maps/api/js?language=th" type="text/javascript"></script>
		<? //if($isAdmin): ?>
		<!--<script src="../js/admin.js"></script>-->

		<script>
var gapApp = new angular.module('gapApp', ['ngRoute', 'ngSanitize', 'angularUtils.directives.dirPagination', 'ui.bootstrap', 'ui.select', /*'daterangepicker', 'ui.bootstrap.datetimepicker', 'ui.grid',*/ 'uiGmapgoogle-maps']);

gapApp.config(function($routeProvider, uiSelectConfig, uiGmapGoogleMapApiProvider){
        // TAMIS Improvement //
        // For call full map //
	
	$routeProvider.otherwise({
		redirectTo: '/dashboard'
	});

	uiSelectConfig.theme = 'selectize';
	// new key = AIzaSyAcUV8hdrjLv6LLf8TEyFRKygliAO8N-oE
	// old key = AIzaSyDzsQPZ0pOhEaddE2U5Ct36kEG9SeRkUbY
	uiGmapGoogleMapApiProvider.configure({
		key: 'AIzaSyAcUV8hdrjLv6LLf8TEyFRKygliAO8N-oE',
		v: '3.17',
		libraries: 'weather,geometry,visualization'
	});
});
gapApp.controller('MainCtrl', function($scope, $http, $location){
	$scope.is_active = function(tab){
		return ($location.path() === tab);
	};
});

// ADD by TAMIS Improvement //
gapApp.controller('ActvityDtlCtrl', function($scope, $http, uiGmapIsReady, uiGmapGoogleMapApi, $modal){
    $scope.charts = {
        // Dont't forget get ref id //
        apiUrl: '../api/activityDtl/'
    };
    //$http.get($scope.charts.apiUrl).success(function(response){
    //$scope.map = new google.maps.Map(document.getElementById('map'), mapOptions);
/*
        $scope.onClick = function() {
            showWindow = true;
            // Get Detail Plantation Activity //
            $http.get(chart.apiDtlUrl.concat(coords.site_uuid)).success(function(response){
                //item.coords.message = response.message;
                coords.message = response.message;
                $scope.message = response.message;
            });

        };
*/
    alert(1111111111111111);
    /*
    $http.get($scope.charts.apiUrl.concat($scope.coords.site_uuid)).success(function(response){

    });
    */
});


// Modify TAMIS Improvement //
gapApp.controller('DashboardCtrl', function($scope, $http, uiGmapIsReady, uiGmapGoogleMapApi, $modal){
	$scope.charts = {
		/* STOP SERVICE ON REPORT DASHBOARD

		province:{
			apiUrl: 'api/statistics/province',
			chartType: 'donut'
		},

		producttype:{
			apiUrl: 'api/statistics/producttype',
			chartType: 'donut'
		},status:{
			apiUrl: 'api/statistics/status',
			chartType: 'bar'
		},device:{
			apiUrl: 'api/statistics/device',
			chartType: 'bar'
		},office:{
			apiUrl: 'api/statistics/office',
			chartType: 'donut'
		}, */

		/*productstatus:{
			apiUrl: 'api/statistics/productstatus',
			chartType: 'table'
		},*/

		/*provincesite:{
			apiUrl: 'api/statistics/provincesite',
			chartType: 'donut'
		},*/


		statusmap:{
			apiUrl:  '../api/statistics/productlocation',
                        apiDtlUrl: '../api/activityDtl/',
			chartType: 'map',
			markers: [],
			map: {
				center: {latitude: 13.7245995, longitude: 100.6331106},
                                //center: {latitude: 12.5210831698587000, longitude: 99.9332978359201000},
                                //center: {latitude: 16.8684502088617000, longitude: 102.8536749971570000},
                                //center: {latitude: 12.8373755343531000, longitude: 100.9098164323340000},
				zoom: 10,
				bounds: {},
				control: {},
				options: {}
			}
		}
	};
        // Modify TAMIS Improvement //
        $scope.map = {
          pan: true,
          zoom: 16,
          refresh: false,
          events: {},
          bounds: {},
          polys: [],
          draw: undefined
        };
        $scope.message = "";
	angular.forEach($scope.charts, function(chart, id){
                // Modify TAMIS Improvement //
                // HTTP Get list of value from API in attribute apiUrl //
		$http.get(chart.apiUrl).success(function(response){
                        // IF Succes to do in case as below //
			switch(chart.chartType){
				case 'donut':
					Morris.Donut({
						element: id,
						data: response.items,
						colors: ['#85144b', '#f56954', '#f39c12', '#39cccc', '#00c0ef', '#0073b7', '#3c8dbc', '#001f3f', '#3d9970', '#00a65a', '#01ff70'],
						formatter: function (x) { return x + " ราย"; }
					});
					break;
				case 'bar':
					Morris.Bar({
						element: id,
						resize: true,
						data: response.items,
						barColors: ['#00c0ef', '#00a65a', '#3c8dbc', '#f56954'],
						xkey: 'y',
						ykeys: response.keys,
						labels: response.keys,
						hideHover: 'auto'
					});
					break;
				case 'table':
					$scope.productstatus = response;
					break;
				case 'map':
                                        // Modify TAMIS Improvement //
                                        // Case display data on Google Map //
                                        // Modify check center of display from API ?? //
                                        if ((response.map.center.latitude != "" ) && (response.map.center.longitude != "" )) {
                                            // Set new center of display //
                                            chart.map.center.latitude = 13.7245995;
                                            chart.map.center.longitude = 100.6331106;
                                        }
                                        // Get reponse from API //
					var items = response.items;
                                        // Polygon //
                                        var rawPolys = [];
                                        var polygons = response.polygons;
					window.chart = chart;
					angular.forEach(items, function(coords, key){
					    var item = {id: key,
							coords: coords,
							showWindow: false,
							closeClick: function(){
 								item.showWindow = false;
							},

                                                        ///////////////////////////////////////////
                                                        // Modify TAMIS Improvement //
							//onClicked: function() {
								//item.showWindow = true;
                                                                // Get Detail Plantation Activity //
                                                                /*
                                                                $http.get(chart.apiDtlUrl.concat(coords.site_uuid)).success(function(response){
                                                                    //item.coords.message = response.message;
                                                                    //coords.message = response.message;
                                                                    //$scope.$root.windowClicked = function () {alert('here')}
                                                                    //$scope.message = response.message;
                                                                    //$scope.message.push(response.message);
                                                                    return response.message;
                                                                    //item.message = response.message;
                                                                }, function(error) {
                                                                    alert(error.err_msg);
                                                                });
                                                                */
                                                                // End Get Dtl //
                                                                /*
								var modalInstance = $modal.open({
									templateUrl: '../tmpl/site_edit.html',
									controller: 'SiteCtrl',
									size: 'lg',
									backdrop: 'static',
									resolve: {
										site_uuid: function () {
											return coords.site_uuid;
										}
									}
								});
                                                                */
							//},
                                                        ///////////////////////////////////////////
						};
						this.push(item);
					}, chart.markers);
                                        // Modify TAMIS Improvement //
                                        // Write Data Layer //
	                                uiGmapGoogleMapApi.then( function () {
                                            //$log.debug("poly length: " + data.data.length);
                                            $scope.map.polys = polygons;
                                            rawPolys = polygons;
                                        });
                                        // End Write Data Layer //
					break;
			}

		});
	});

});


gapApp.controller('SiteCtrl', function($scope, $http, $modalInstance, $modal, uiGmapGoogleMapApi, site_uuid){
	$scope.site_uuid = site_uuid;
	var req = {
		method: 'GET',
		url: '../api/products_edit',
		params: {
			site_uuid: site_uuid
		}
	};

	$scope.status = {
		registered: 'เกษตรกรยื่นขอลงทะเบียนแล้ว',
		accepted: 'รับเรื่องลงทะเบียนแล้ว',
		inspected: 'ผ่านการตรวจประเมินแล้ว',
		suspended: 'ถูกระงับ',
		certified: 'ผ่านการรับรองมาตรฐานแล้ว'
	};

	$http(req).success(function(response){
		$scope.products = response.items;
		$scope.totalItems = response.totalItems;
	});
	$scope.cancel = function () {
		$modalInstance.dismiss('cancel');
	};

	$scope.open = function (boundary) {
		uiGmapGoogleMapApi.then(function(maps) {
			var latlngs = _.sortBy(boundary, function(latlng){
				return latlng.no;
			});
			var path = [];
			var bounds = new maps.LatLngBounds();
			for(var i in latlngs){
				var latlng = new maps.LatLng(latlngs[i].lat, latlngs[i].lng);
				path[i] = latlng;
				bounds.extend(latlng);
			}
			var modalInstance = $modal.open({
				templateUrl: '../tmpl/product.html',
				controller: 'ProductCtrl',
				size: 'lg',
				backdrop: 'static',
				resolve: {
					boundary: function () {
						return {path: path, bounds: bounds};
					}
				}
			});
		});
	};
});

gapApp.controller('SitesCtrl', function($scope, $http, $modal){
	$scope.page = 1;
	$scope.sites = {
		items: null,
		totalItems: 0
	};
	$scope.dirs = ['', 'asc', 'desc'];
	$scope.dir = 0;
	$scope.input = {
		filter: '',
		start: 1,
		num: 25,
		sort: '',
		dir: 'asc'
	};

	$scope.open = function (site_uuid) {
		var modalInstance = $modal.open({
			templateUrl: '../tmpl/site.html',
			controller: 'SiteCtrl',
			size: 'lg',
			backdrop: 'static',
			resolve: {
				site_uuid: function () {
					return site_uuid;
				}
			}
		});
	};
	$scope.list = function(){
		$http({
			method: 'GET',
			url: '../api/sites',
			params: $scope.input
		}).success(function(response){
			$scope.sites = response;
		});
	};

	$scope.changeSort = function(sort){
		if(sort == $scope.input.sort){
			$scope.dir = ($scope.dir + 1) % 3;
		}else{
			$scope.input.sort = sort;
			$scope.dir = 1;
		}
		$scope.input.dir = $scope.dirs[$scope.dir];
		if($scope.dir === 0){
			delete $scope.input.sort;
			delete $scope.input.dir;
		}
		$scope.list();
	};

	$scope.$watch('page', function(newPage, oldPage){
		$scope.input.start = ((newPage - 1) * $scope.input.num) + 1;
		$scope.list();
	});
});

gapApp.controller('ProductCtrl', function($scope, $http, $modalInstance, uiGmapIsReady, boundary){
	$scope.boundary = boundary.path;
	$scope.bounds = boundary.bounds;
	$scope.fill =  {
		color: '#46D6C5',
		opacity: 0.5
	};
	$scope.stroke = {
		color: '#3EC0B1',
		weight: 1
	};
	$scope.map = {
		center: {
			latitude: 13.7245995,
			longitude: 100.6331106
		},
		zoom: 15,
		bounds: {},
		control: {},
		options: {
			mapTypeId: "hybrid"
		}
	};
/* 	uiGmapGoogleMapApi.then(function(maps) {
		console.log("maps",maps);
		console.log('control',$scope.map.control);
    }); */
	uiGmapIsReady.promise().then(function(instances) {
		var map = $scope.map.control.getGMap();
		var control = $scope.map.control;
		control.refresh();
		map.fitBounds($scope.bounds);
		map.setMapTypeId('hybrid');

/* 		instances.forEach(function(inst) {
			console.log('inst.map', inst.map);
		}); */
	});
	$scope.cancel = function () {
		$modalInstance.dismiss('cancel');
	};
});

gapApp.controller('ProductsCtrl', function($scope, $http, $modal, uiGmapGoogleMapApi){
	$scope.page = 1;
	$scope.products = {
		items: null,
		totalItems: 0
	};
	$scope.dirs = ['', 'asc', 'desc'];
	$scope.dir = 0;
	$scope.input = {
		filter: '',
		start: 1,
		num: 25,
		sort: '',
		dir: 'asc'
	};

	$scope.status = {
		registered: 'เกษตรกรยื่นขอลงทะเบียนแล้ว',
		accepted: 'รับเรื่องลงทะเบียนแล้ว',
		inspected: 'ผ่านการตรวจประเมินแล้ว',
		suspended: 'ถูกระงับ',
		certified: 'ผ่านการรับรองมาตรฐานแล้ว'
	};

	$scope.open = function (boundary) {
		uiGmapGoogleMapApi.then(function(maps) {
			var latlngs = _.sortBy(boundary, function(latlng){
				return latlng.no;
			});
			var path = [];
			var bounds = new maps.LatLngBounds();
			for(var i in latlngs){
				var latlng = new maps.LatLng(latlngs[i].lat, latlngs[i].lng);
				path[i] = latlng;
				bounds.extend(latlng);
			}
			var modalInstance = $modal.open({
				templateUrl: '../tmpl/product.html',
				controller: 'ProductCtrl',
				size: 'lg',
				backdrop: 'static',
				resolve: {
					boundary: function () {
						return {path: path, bounds: bounds};
					}
				}
			});
		});
	};

	$scope.list = function(){
		$http({
			method: 'GET',
			url: '../api/products',
			params: $scope.input
		}).success(function(response){
			$scope.products = response;
		});
	};

	$scope.changeSort = function(sort){
		if(sort == $scope.input.sort){
			$scope.dir = ($scope.dir + 1) % 3;
		}else{
			$scope.input.sort = sort;
			$scope.dir = 1;
		}
		$scope.input.dir = $scope.dirs[$scope.dir];
		if($scope.dir === 0){
			delete $scope.input.sort;
			delete $scope.input.dir;
		}
		$scope.list();
	};

	$scope.$watch('page', function(newPage, oldPage){
		$scope.input.start = ((newPage - 1) * $scope.input.num) + 1;
		$scope.list();
	});

});
		</script>


				<? //else: ?>
<!-- 		<script src="js/app.js"></script> -->
		<? //endif ;?>
		<link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="../css/bootstrap-theme.min.css">
		<link rel="stylesheet" type="text/css" href="../css/AdminLTE.css">
		<link rel="stylesheet" type="text/css" href="../css/ionicons.min.css">
		<link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css">
<!-- 		<link rel="stylesheet" type="text/css" href="css/datetimepicker.css"> -->
<!-- 		<link rel="stylesheet" type="text/css" href="css/daterangepicker-bs3.css"> -->
		<link rel="stylesheet" type="text/css" href="../css/select.css">
 		<link rel="stylesheet" type="text/css" href="../css/ui-grid-unstable.min.css">
		<link rel="stylesheet" type="text/css" href="../css/morris.css">
		<link rel="stylesheet" type="text/css" href="../css/style.css">

		<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.8.5/css/selectize.default.css">
		<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.8.5/css/selectize.bootstrap3.css">

	</head>
	<body data-ng-app="gapApp">
            <div ng-view>
	    </div>
        </body>
</html>
